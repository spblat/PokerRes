<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poker Game Reservations</title>
    <style>
        #app, #error { display: none; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <!-- Password Form -->
    <div id="passwordForm">
        <input type="password" id="passwordInput" placeholder="">
        <button id="submitPassword">Enter</button>
        <p id="error" style="color:red;">Incorrect password. Try again.</p>
    </div>

    <!-- Main App -->
    <div id="app">
        <h2>Date: <span id="gameDate"></span></h2>

        <!-- Venue Availability -->
        <h4>Venue is available:</h4>
        <div>
            <label>
                <input type="radio" name="venue" value="yes"> Yes
            </label><br>
            <label>
                <input type="radio" name="venue" value="no"> No
            </label><br>
            <label>
                <input type="radio" name="venue" value="unknown" checked> Unknown
            </label>
        </div>

        <!-- Player List -->
        <h4>Players</h4>
        <div id="mainPlayers">
            <div><label>Player 1: <input type="text" class="player"></label></div>
            <div><label>Player 2: <input type="text" class="player"></label></div>
            <div><label>Player 3: <input type="text" class="player"></label></div>
            <div><label>Player 4: <input type="text" class="player"></label></div>
            <div><label>Player 5: <input type="text" class="player"></label></div>
            <div><label>Player 6: <input type="text" class="player"></label></div>
            <div><label>Player 7: <input type="text" class="player"></label></div>
            <div><label>Player 8: <input type="text" class="player"></label></div>
            <div><label>Player 9: <input type="text" class="player"></label></div>
            <div><label>Player 10: <input type="text" class="player"></label></div>
        </div>

        <!-- Alternates/Maybes -->
        <h4>Alternates/Maybes</h4>
        <div id="alternates">
            <div><label>Alternate 1: <input type="text" class="player"></label></div>
            <div><label>Alternate 2: <input type="text" class="player"></label></div>
            <div><label>Alternate 3: <input type="text" class="player"></label></div>
            <div><label>Alternate 4: <input type="text" class="player"></label></div>
        </div>

        <!-- Submit Button -->
        <button id="submitChanges">Submit Changes</button>

        <p id="collisionMessage" style="color:red; display:none;">Sorry, someone else made a change while you were typing. Please try again.</p>
    </div>

    <script>
        const apiKey = '$2a$10$n2R7cE.TDZUvv3pHSw0tb.SnA2rQat9H2ol3QMcOFOPn2WAKUXSRa';
        const binId = '66f1b7d0acd3cb34a889ea39';
        let lastModifiedTimestamp;

        // Hardcoded password for now, to be saved into JSON later
        let hardcodedPassword = "poker123";

        // Fetch the data and set up the page
        async function fetchPasswordAndAuthenticate() {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
                    headers: {
                        'X-Access-Key': apiKey
                    }
                });
                const result = await response.json();
                lastModifiedTimestamp = result.metadata.modifiedAt;  // Keep track of when the JSON was last modified

                const inputPassword = document.getElementById('passwordInput').value;

                // Check if the password matches (hardcoded for now)
                if (inputPassword === result.record.password) {
                    document.getElementById('passwordForm').style.display = 'none';
                    document.getElementById('app').style.display = 'block';
                    const jsonData = result.record;
                    handleDateValidation(jsonData);  // Validate the date
                } else {
                    document.getElementById('error').style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching JSON:', error);
            }
        }

        document.getElementById('submitPassword').addEventListener('click', fetchPasswordAndAuthenticate);

        // Function to calculate the next Monday's date
        function calculateNextMonday() {
            const today = new Date();
            let dayOfWeek = today.getDay();
            let daysUntilMonday = (1 - dayOfWeek + 7) % 7;

            if (daysUntilMonday === 0) {
                daysUntilMonday = 0;  // It's Monday today
            }

            const nextMonday = new Date(today);
            nextMonday.setDate(today.getDate() + daysUntilMonday);

            // Format the date
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return nextMonday.toLocaleDateString(undefined, options);
        }

        // Validate the date in the JSON and reset if necessary
        function handleDateValidation(jsonData) {
            const today = new Date();
            const jsonDate = new Date(jsonData.date);

            if (jsonDate < today) {
                // Data is old, discard and reset the form
                resetFormFields();
                // Update the date to the upcoming Monday
                jsonData.date = calculateNextMonday();
            } else {
                // Populate form with existing data
                populateFormFields(jsonData);
            }
        }

        // Populate the form fields with the data from JSON
        function populateFormFields(data) {
            document.getElementById('gameDate').textContent = data.date;

            // Populate venue availability
            document.querySelector(`input[name="venue"][value="${data.venue}"]`).checked = true;

            // Populate players
            const playerInputs = document.querySelectorAll('#mainPlayers input');
            data.players.forEach((player, index) => {
                if (playerInputs[index]) {
                    playerInputs[index].value = player;
                }
            });

            // Populate alternates
            const alternateInputs = document.querySelectorAll('#alternates input');
            data.alternates.forEach((alternate, index) => {
                if (alternateInputs[index]) {
                    alternateInputs[index].value = alternate;
                }
            });
        }

        // Reset the form fields to blank values
        function resetFormFields() {
            // Reset venue availability
            document.querySelector('input[name="venue"][value="unknown"]').checked = true;

            // Clear player fields
            const playerInputs = document.querySelectorAll('#mainPlayers input');
            playerInputs.forEach(input => input.value = '');

            // Clear alternate fields
            const alternateInputs = document.querySelectorAll('#alternates input');
            alternateInputs.forEach(input => input.value = '');
        }

        // Submit form data and propagate the password into the JSON
        async function submitFormData() {
            try {
                // Check for collision by re-fetching the JSON and comparing timestamps
                const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
                    headers: {
                        'X-Access-Key': apiKey
                    }
                });
                const result = await response.json();
                const currentModifiedTimestamp = result.metadata.modifiedAt;

                // If the timestamps differ, someone else has made a change
                if (currentModifiedTimestamp !== lastModifiedTimestamp) {
                    document.getElementById('collisionMessage').style.display = 'block';
                    return;  // Stop submission
                }

                // If no collision, update the data and propagate the password
                const formData = {
                    date: calculateNextMonday(),
                    venue: document.querySelector('input[name="venue"]:checked').value,
                    players: Array.from(document.querySelectorAll('#mainPlayers input')).map(input => input.value),
                    alternates: Array.from(document.querySelectorAll('#alternates

 input')).map(input => input.value),
                    password: result.record.password  // Keep the password intact
                };

                await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Access-Key': apiKey
                    },
                    body: JSON.stringify(formData)
                });

                alert('Changes submitted successfully!');

            } catch (error) {
                console.error('Error submitting JSON:', error);
            }
        }

        document.getElementById('submitChanges').addEventListener('click', submitFormData);
    </script>
</body>
</html>
