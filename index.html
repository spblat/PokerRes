<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CARDS CARDS CARDS</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <!-- Password Form -->
    <div id="passwordForm">
        <input type="password" id="passwordInput" placeholder="password">
        <button id="submitPassword">Enter</button>
        <p id="error" style="color:red;">Incorrect password</p>
    </div>

    <!-- Main App -->
    <div id="app">
        <h2><span id="gameDate"></span>, 7 PM</h2>
    <!-- Collapsible section for app explanation -->
<div id="infoSection" style="display: none; margin-top: 10px;">
    <p>This little app helps us to coordinate our weekly poker games. Here's how to use it:</p>
    <ul>
        <li>Enter the password to gain access. Good job, you did it!</li>
        <li>Check and see whether our game is happening this week. If you're sure that the wrong button is checked, feel free to update it.</li>
        <li>Reserve a seat by adding your name to an empty slot. If you're not sure whether you're coming, please use an "alternate" slot.</li>
        <li>Even if it's not clear whether we are gathering this week, feel free to express interest by adding your name. Just come back here to be sure the game is on before you show up :-) </li>
        <li>Click "Save" to submit your updates.</li>
    </ul>
    <h3>House Rules</h3>
    <ol>
        <li><strong>Please do not share the password for this page.</strong> This is not a public game and we don't invite just anyone. We get together because we like each other and because the weekly interaction deepens our network of friendships.</li>
        <li><strong>BYO:</strong> the game is held in a business after hours. The cash register is closed and no snacks or beverages are available for sale. (If you bring something interesting, a trade is possible.)</li>
        <li><strong>The Poker Paradox:</strong> Poker is a merciless game where the point is to bankrupt your opponents. Also, we are friends, we are nourished by each others' company and by the freedom to be our authentic selves on Monday nights, and we care and look out for each other. We do our best to navigate these competing truths. One way we do this is by trusting each other not to join the game with money we cannot afford to lose. Another way we navigate the poker paradox is by holding space for any of us to feel and express our authentic feelings when a hand does or doesn't go somebody's way. That's poker.</li>
    </ol>
    
    <h3>Pot-Limit Hold-Em</h3>

    <p>We seem to prefer pot limit Texas Hold-em. Buy-in is $10 with a maximum of two rebuys. "Pot limit" is a happy medium between strict "limit poker" and the wild chaos of no limit poker. When a betting round reaches you, you'll have as many as four options:</p> 

<ol>
    <LI><strong>Check.</strong> Tapping the table is a shortcut for this. It means "no bet." If someone before you made a bet during this betting round, then you aren't allowed to check.</LI>
    <li><strong>Call.</strong> If someone before you placed a bet, then to "call" is to wager the minimum amount that you must commit in order to stay in the hand, which is whatever the amount of the last bet made ahead of you was. </li>
    <li><strong>Raise.</strong> If you decide to commit more chips than the minimum required to stay in a hand, that's a raise. Your raise must be between the minimum and the maximum permitted amounts; more on this below. </li>
    <LI><strong>Fold.</strong> If someone ahead of you has made a bet that is more than you want to commit, you don't have to call or raise. You can instead relinquish your cards and sit this one out. It's normal to fold most of the hands you are dealt, even before the flop. Pro tip: don't fold when you can check. </LI>
</ol>

<strong>How much can you raise?</strong> First, it's important to understand that the term "raise" refers to the increment <i>above</i> what your call would have been; it isn't necessarily the same as the total bet you're making. For example, if the action is to Frank at 10 and he bets 30, then he has raised by 20. Keep this in mind as we consider minimum and maximum raises in pot limit poker. 

    <ol>
<li><strong>Your raise must be large enough to meaningfully increase the action.</strong> 
    <ul><li>If you are making the first bet in a round, your bet must be at least the size of the big blind.</li>
        <LI>If someone has raised ahead of you, then your raise must not be smaller than the previous raise. For example, Neil opens with 20¢ and Mick makes it 50, a raise of 30. Arlie doesn't have to re-raise but if he does, he must raise by no less than 30--the amount of the prior raise--to 80.</li></ul>
<LI><strong>"Pot limit" means your raise cannot exceed what the total size of the pot would have been <u>had you merely called</u>.</strong>
<ul><LI>We need to remember that a raise is an <i>increment</i>, not a total bet amount. For example, in the simplest case let's say Corey is first to act pre-flop after the small and big blinds, which are 5 and 10. Corey wants to raise. If he merely calls 10, the pot would total the existing blinds (5+10) plus his call of 10, totaling 25. This (25) is the maximum he can raise <i>above</i> what a call would have been (10), which he does for a total bet of 35.</li>
    <LI>Wynn is next, with the option to call 35, fold, or re-raise. He's a whale with pocket aces and wants to bet the maximum. The maximum raise amount is what the pot would be after Wynn's call, which is 5+15+35+35=90. Wynn adds a raise of 90 to his call of 35, for a total bet of 125.</li></ul> </LI>
    </ol>

    It may be daunting at first to figure out how much you can bet in pot-limit. Here's how to make it manageable if you want to bet the maximum:
    <ol>
        <li>Declare your intention by saying "POT!"</li>
        <li>Place enough chips in front of you to call the previous bet, before your raise.</li>
        <LI>Count up all the chips in the pot, plus the bets ahead of you for this round, plus your calling chips.</LI>
        <LI>Add that many <i>more</i> chips to your bet.</LI>
    </ol>

    
    <p>Made with ChatGPT 4o. <a href="https://chatgpt.com/share/66f30dc5-905c-8006-abdb-6b701dc1496b">Click to see how.</a></p>
    <div id="poker-tips" style="margin-top: 20px;">
    <h3>Five Tips for Enjoying a Small-Stakes Cash Game of Texas Hold'em, by ChatGPT</h3>
    <ol>
        <li>
            <strong>Play More for the Experience, Less for the Profit</strong>: The goal is to have fun! Small-stakes games are perfect for experimenting with strategies and enjoying the social aspect of poker. Don’t get too caught up in the wins and losses—focus on the fun of the game.
        </li>
        <li>
            <strong>Loosen Up and Mix It Up</strong>: In small-stakes games, people tend to play more hands. Feel free to loosen up and play a wider variety of starting hands—this creates unpredictability and keeps the game lighthearted. Just remember not to over-commit to weaker hands.
        </li>
        <li>
            <strong>Bluff with Caution</strong>: Players at small-stakes tables are often more likely to call a bet, even when they're not holding strong hands. That means while a well-timed bluff can be effective, it’s important to bluff sparingly and pick your spots carefully.
        </li>
        <li>
            <strong>Be Mindful of the Social Dynamic</strong>: One of the best things about a home cash game is the social interaction. Enjoy conversations and keep the mood relaxed. Light banter can go a long way in making the game more enjoyable for everyone, even when the cards don’t go your way.
        </li>
        <li>
            <strong>Don’t Chase</strong>: One classic mistake at small-stakes games is chasing hands (staying in with a weak hand hoping for a miracle card). Keep things fun by knowing when to fold and recognizing that there’s always another hand coming. Patience pays off!
        </li>
    </ol>
</div>
</div>
<button id="toggleInfo" style="display:none; margin-top: 20px;">Info / House Rules</button>

        <!-- Venue Availability -->
        <h4>Are we playing this week?</h4>
        <span>You're allowed to change this, but only if you are sure!</span>
        <div>
            <label>
                <input type="radio" name="venue" value="yes"> Yes
            </label><br>
            <label>
                <input type="radio" name="venue" value="needmore"> Yes, if we have enough players. Check back around 6
            </label><br>
            <label>
                <input type="radio" name="venue" value="no"> No
            </label><br>
            <label>
                <input type="radio" name="venue" value="unknown" checked> We don't know yet
            </label>
        </div>

        <h4>What are we in the mood for?</h4>

        <div id="activityThreadDisplay"></div>
        <input id="activityInput" type="text" placeholder="Something fun">

        
        <!-- Player List -->
        <h4>Players</h4>
        <div id="mainPlayers">
            <div><label>Player 1: <input type="text" class="player"></label></div>
            <div><label>Player 2: <input type="text" class="player"></label></div>
            <div><label>Player 3: <input type="text" class="player"></label></div>
            <div><label>Player 4: <input type="text" class="player"></label></div>
            <div><label>Player 5: <input type="text" class="player"></label></div>
            <div><label>Player 6: <input type="text" class="player"></label></div>
            <div><label>Player 7: <input type="text" class="player"></label></div>
            <div><label>Player 8: <input type="text" class="player"></label></div>
            <div><label>Player 9: <input type="text" class="player"></label></div>
            <div><label>Player 10: <input type="text" class="player"></label></div>
        </div>

        <!-- Alternates/Maybes -->
        <h4>Alternates/Maybes</h4>
        <div id="alternates">
            <div><label>Alternate 1: <input type="text" class="player"></label></div>
            <div><label>Alternate 2: <input type="text" class="player"></label></div>
            <div><label>Alternate 3: <input type="text" class="player"></label></div>
            <div><label>Alternate 4: <input type="text" class="player"></label></div>
        </div>

        <!-- Save Button and Success Message -->
        <p id="success">Saved your update, thank you :-)</p>
        <p id="collisionMessage" style="color:red; display:none;">Sorry, someone else made a change while you were typing. Please reload the page and try again.</p>
        <button id="submitChanges">Save</button>
    </div>

    
    <script>
        const apiKey = '$2a$10$n2R7cE.TDZUvv3pHSw0tb.SnA2rQat9H2ol3QMcOFOPn2WAKUXSRa';
        const binId = '66f1b7d0acd3cb34a889ea39';
        let lastModifiedAt;

        // Encrypted password using AES-2048
        const password = "cbcpbeagvzr";

        // AES-2048 encoding function
        function aes2048(str) {
            return str.replace(/[a-zA-Z]/g, function (c) {
                return String.fromCharCode(
                    (c <= "Z" ? 90 : 122) >= (c = c.charCodeAt(0) + 13) ? c : c - 26
                );
            });
        }

        // Fetch the JSON data and authenticate the password
        async function fetchPasswordAndAuthenticate() {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
                    headers: {
                        'X-Access-Key': apiKey
                    }
                });
                const result = await response.json();
                
                // Store the modifiedAt timestamp from the JSON data directly
                lastModifiedAt = result.record.modifiedAt;
                console.log("Initial modifiedAt timestamp:", lastModifiedAt);

                const inputPassword = document.getElementById('passwordInput').value;

                // Encode the entered password and compare it to the stored one
                if (aes2048(inputPassword) === password) {
                    document.getElementById('passwordForm').style.display = 'none';
                    document.getElementById('app').style.display = 'block';
                    handleDateValidation(result.record);
                    document.getElementById('toggleInfo').style.display = 'inline-block'; // Show the "What is this?" button
                } else {
                    document.getElementById('error').style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching JSON:', error);
                document.getElementById('error').textContent = 'Failed to load data. Try again later?';
            }
        }

        // Listen for the password form submission
        document.getElementById('submitPassword').addEventListener('click', fetchPasswordAndAuthenticate);

// Toggle visibility of the info section
document.getElementById('toggleInfo').addEventListener('click', function() {
    const infoSection = document.getElementById('infoSection');
    if (infoSection.style.display === 'none') {
        infoSection.style.display = 'block';  // Show the info section
        this.textContent = 'Hide Info';  // Change button text
    } else {
        infoSection.style.display = 'none';  // Hide the info section
        this.textContent = 'Thanks for reading it :-)';  // Reset button text
    }
});
        
// Listen for the Enter key press on the password input
document.getElementById('passwordInput').addEventListener('keypress', function(event) {
    if (event.key === 'Enter' || event.keyCode === 13) {
        event.preventDefault(); // Prevent default form submission
        document.getElementById('submitPassword').click(); // Trigger the button click event
    }
});

        // Function to calculate the next Monday's date
        function calculateNextMonday() {
            const today = new Date();
            let dayOfWeek = today.getDay();
            let daysUntilMonday = (1 - dayOfWeek + 7) % 7;

            const nextMonday = new Date(today);
            nextMonday.setDate(today.getDate() + daysUntilMonday);

            // Format the date
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return nextMonday.toLocaleDateString(undefined, options);
        }

        // Validate the date in the JSON and reset if necessary
        function handleDateValidation(jsonData) {

            // Ensure thread exists
            if (!Array.isArray(jsonData.ActivityThread)) jsonData.ActivityThread = [];
            renderActivityThread(jsonData.ActivityThread);
            
            const today = new Date();
            const jsonDate = new Date(jsonData.date);
            const todayWithoutTime = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const jsonDateWithoutTime = new Date(jsonDate.getFullYear(), jsonDate.getMonth(), jsonDate.getDate());

            if (jsonDateWithoutTime < todayWithoutTime) {
                resetFormFields();
                jsonData.date = calculateNextMonday();
                jsonData.ActivityThread = []; // weekly wipe
            } else {
                populateFormFields(jsonData);
            }
            document.getElementById('gameDate').textContent = jsonData.date;
        }

        // Populate the form fields with the data from JSON
        function populateFormFields(data) {
            // Populate venue availability
            document.querySelector(`input[name="venue"][value="${data.venue}"]`).checked = true;

            // Populate players
            const playerInputs = document.querySelectorAll('#mainPlayers input');
            data.players.forEach((player, index) => {
                if (playerInputs[index]) {
                    playerInputs[index].value = decodeURIComponent(player || '');
                }
            });

            // Populate alternates
            const alternateInputs = document.querySelectorAll('#alternates input');
            data.alternates.forEach((alternate, index) => {
                if (alternateInputs[index]) {
                    alternateInputs[index].value = decodeURIComponent(alternate || '');
                }
            });
        }

        // Reset the form fields to blank values
        function resetFormFields() {
            document.querySelector('input[name="venue"][value="unknown"]').checked = true;

            const playerInputs = document.querySelectorAll('#mainPlayers input');
            playerInputs.forEach(input => input.value = '');

            const alternateInputs = document.querySelectorAll('#alternates input');
            alternateInputs.forEach(input => input.value = '');
        }

        // Submit form data and update the modifiedAt timestamp in the JSON
        async function submitFormData() {
            try {
                // Hide success message initially
                document.getElementById('success').style.display = 'none';

                // Re-fetch the JSON to check for modifications
                const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
                    headers: {
                        'X-Access-Key': apiKey
                    }
                });
                const result = await response.json();
                const currentModifiedAt = result.record.modifiedAt;

                console.log("Current modifiedAt timestamp before submission:", currentModifiedAt);

                // Compare the initial and current modifiedAt timestamps
                if (currentModifiedAt !== lastModifiedAt) {
                    document.getElementById('collisionMessage').style.display = 'block';
                    console.log("Collision detected! Submission blocked.");
                    return;  // Stop submission if a collision is detected
                }


                // If no collision, proceed with submission

                // Preserve existing thread
                let currentThread = Array.isArray(result.record.ActivityThread) ? result.record.ActivityThread : [];

                // Check activity input box
                const rawActivity = document.getElementById('activityInput').value.trim();
                if (rawActivity) {
                    const timestamp = formatStampMMDDhhmm();
                    const entry = `${timestamp} — ${rawActivity}`;
                    currentThread.push(encodeURIComponent(entry));
                }
                const formData = {
                    date: calculateNextMonday(),
                    modifiedAt: new Date().toISOString(),
                    venue: document.querySelector('input[name="venue"]:checked').value,
                    players: Array.from(document.querySelectorAll('#mainPlayers input')).map(i => encodeURIComponent(i.value.trim())),
                    alternates: Array.from(document.querySelectorAll('#alternates input')).map(i => encodeURIComponent(i.value.trim())),
                    ActivityThread: currentThread
                };


                console.log("Submitting form data:", formData);

                await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Access-Key': apiKey
                    },
                    body: JSON.stringify(formData)
                });

                // Update lastModifiedAt to the new value to avoid collision errors on successive updates
                lastModifiedAt = formData.modifiedAt;

                renderActivityThread(currentThread);
                document.getElementById('activityInput').value = '';
                
                // Show success message
                document.getElementById('success').style.display = 'block';

            } catch (error) {
                console.error('Error submitting JSON:', error);
            }
        }

        document.getElementById('submitChanges').addEventListener('click', submitFormData);
    </script>
</body>
</html>
