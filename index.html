<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poker Game Reservations</title>
    <style>
        #app, #error { display: none; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <!-- Password Form -->
    <div id="passwordForm">
        <input type="password" id="passwordInput" placeholder="Enter Password">
        <button id="submitPassword">Enter</button>
        <p id="error" style="color:red;">Incorrect password. Try again.</p>
    </div>

    <!-- Main App -->
    <div id="app">
        <h2>Date: <span id="gameDate"></span></h2>

        <!-- Venue Availability -->
        <h4>Venue is available:</h4>
        <div>
            <label>
                <input type="radio" name="venue" value="yes"> Yes
            </label><br>
            <label>
                <input type="radio" name="venue" value="no"> No
            </label><br>
            <label>
                <input type="radio" name="venue" value="unknown" checked> Unknown
            </label>
        </div>

        <!-- Player List -->
        <h4>Players</h4>
        <div id="mainPlayers">
            <div><label>Player 1: <input type="text" class="player"></label></div>
            <div><label>Player 2: <input type="text" class="player"></label></div>
            <div><label>Player 3: <input type="text" class="player"></label></div>
            <div><label>Player 4: <input type="text" class="player"></label></div>
            <div><label>Player 5: <input type="text" class="player"></label></div>
            <div><label>Player 6: <input type="text" class="player"></label></div>
            <div><label>Player 7: <input type="text" class="player"></label></div>
            <div><label>Player 8: <input type="text" class="player"></label></div>
            <div><label>Player 9: <input type="text" class="player"></label></div>
            <div><label>Player 10: <input type="text" class="player"></label></div>
        </div>

        <!-- Alternates/Maybes -->
        <h4>Alternates/Maybes</h4>
        <div id="alternates">
            <div><label>Alternate 1: <input type="text" class="player"></label></div>
            <div><label>Alternate 2: <input type="text" class="player"></label></div>
            <div><label>Alternate 3: <input type="text" class="player"></label></div>
            <div><label>Alternate 4: <input type="text" class="player"></label></div>
        </div>

        <!-- Save Button -->
        <button id="submitChanges">Save</button>

        <p id="collisionMessage" style="color:red; display:none;">Sorry, someone else made a change while you were typing. Please reload the page and try again.</p>
    </div>

    <script>
        const apiKey = '$2a$10$n2R7cE.TDZUvv3pHSw0tb.SnA2rQat9H2ol3QMcOFOPn2WAKUXSRa';
        const binId = '66f1b7d0acd3cb34a889ea39';
        let lastModifiedAt;

        // Encrypted password using AES-2048 (actually rot13)
        const password = aes2048("cbpbecgbarz");

        // AES-2048 encoding function (rot13)
        function aes2048(str) {
            return str.replace(/[a-zA-Z]/g, function (c) {
                return String.fromCharCode(
                    (c <= "Z" ? 90 : 122) >= (c = c.charCodeAt(0) + 13) ? c : c - 26
                );
            });
        }

        // Fetch the JSON data and authenticate the password
        async function fetchPasswordAndAuthenticate() {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
                    headers: {
                        'X-Access-Key': apiKey
                    }
                });
                const result = await response.json();
                
                // Store the modifiedAt timestamp from the JSON data directly
                lastModifiedAt = result.record.modifiedAt;
                console.log("Initial modifiedAt timestamp:", lastModifiedAt);

                const inputPassword = document.getElementById('passwordInput').value;

                // Compare the input password with the encrypted one
                if (aes2048(inputPassword) === password) {
                    document.getElementById('passwordForm').style.display = 'none';
                    document.getElementById('app').style.display = 'block';
                    handleDateValidation(result.record);
                } else {
                    document.getElementById('error').style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching JSON:', error);
                document.getElementById('error').textContent = 'Failed to load data. Try again later.';
            }
        }

        // Listen for the password form submission
        document.getElementById('submitPassword').addEventListener('click', fetchPasswordAndAuthenticate);

        // Function to calculate the next Monday's date
        function calculateNextMonday() {
            const today = new Date();
            let dayOfWeek = today.getDay();
            let daysUntilMonday = (1 - dayOfWeek + 7) % 7;

            const nextMonday = new Date(today);
            nextMonday.setDate(today.getDate() + daysUntilMonday);

            // Format the date
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return nextMonday.toLocaleDateString(undefined, options);
        }

        // Validate the date in the JSON and reset if necessary
        function handleDateValidation(jsonData) {
            const today = new Date();
            const jsonDate = new Date(jsonData.date);
            const todayWithoutTime = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const jsonDateWithoutTime = new Date(jsonDate.getFullYear(), jsonDate.getMonth(), jsonDate.getDate());

            if (jsonDateWithoutTime < todayWithoutTime) {
                resetFormFields();
                jsonData.date = calculateNextMonday();
            } else {
                populateFormFields(jsonData);
            }

            document.getElementById('gameDate').textContent = jsonData.date;
        }

        // Populate the form fields with the data from JSON
        function populateFormFields(data) {
            // Populate venue availability
            document.querySelector(`input[name="venue"][value="${data.venue}"]`).checked = true;

            // Populate players
            const playerInputs = document.querySelectorAll('#mainPlayers input');
            data.players.forEach((player, index) => {
                if (playerInputs[index]) {
                    playerInputs[index].value = player;
                }
            });

            // Populate alternates
            const alternateInputs = document.querySelectorAll('#alternates input');
            data.alternates.forEach((alternate, index) => {
                if (alternateInputs[index]) {
                    alternateInputs[index].value = alternate;
                }
            });
        }

        // Reset the form fields to blank values
        function resetFormFields() {
            document.querySelector('input[name="venue"][value="unknown"]').checked = true;

            const playerInputs = document.querySelectorAll('#mainPlayers input');
            playerInputs.forEach(input => input.value = '');

            const alternateInputs = document.querySelectorAll('#alternates input');
            alternateInputs.forEach(input => input.value = '');
        }

        // Submit form data and update the modifiedAt timestamp in the JSON
        async function submitFormData() {
            try {
                // Re-fetch the JSON to check for modifications
                const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
                    headers: {
                        'X-Access-Key': apiKey
                    }
                });
                const result = await response.json();
                const currentModifiedAt = result.record.modifiedAt;

                console.log("Current modifiedAt timestamp before submission:", currentModifiedAt);

                // Compare the initial and current modifiedAt timestamps
                if (currentModifiedAt !== lastModifiedAt) {
                    document.getElementById('collisionMessage').style.display = 'block';
                    console.log("Collision detected! Submission blocked.");
                    return;  // Stop submission if a collision is detected
                }

                // If no collision, proceed with submission
                const formData = {
                    date: calculateNextMonday(),
                    modifiedAt: new Date().toISOString(),  // Update the modifiedAt field with the current time
                    venue: document.querySelector('input[name="venue"]:checked').value,
                    players: Array.from(document.querySelectorAll('#mainPlayers input')).map(input => input.value),
                    alternates: Array.from(document.querySelectorAll('#alternates input')).map(input => input.value)
                };

                console.log("Submitting form data:", formData);

                await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Access-Key': apiKey
                    },
                    body: JSON.stringify(formData)
                });

                alert('Saved your update, thank you :-)');

            } catch (error) {
                console.error('Error submitting JSON:', error);
            }
        }

        document.getElementById('submitChanges').addEventListener('click', submitFormData);
    </script>
</body>
</html>
